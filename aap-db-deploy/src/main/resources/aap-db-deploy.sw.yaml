specVersion: "0.8"
id: aap-db-deploy
version: 0.0.1
name: aap-db-deploy
description: Workflow to launch AAP DB Deploy
annotations:
  - "workflow-type/infrastructure"
dataInputSchema: schemas/aap-db-deploy-input-schema.json
start: LaunchSoftwareTemplate
extensions:
  - extensionid: workflow-uri-definitions
    definitions:
      notifications: "https://raw.githubusercontent.com/parodos-dev/serverless-workflows/main/shared/specs/notifications-openapi.yaml"
functions:
  - name: LaunchSoftwareTemplate
    operation: specs/scaffolder-openapi.yaml#createTask
  - name: GetSoftwareTemplateTask
    operation: "specs/scaffolder-openapi.yaml#getTaskDetails"
  - name: LaunchAAPJob
    operation: specs/aap-openapi.yaml#launchJob
  - name: GetAAPJob
    operation: specs/aap-openapi.yaml#getJob
  - name: createAppsV1NamespacedDeployment
    operation: specs/ocp-openapi.yaml#createAppsV1NamespacedDeployment
  - name: readAppsV1NamespacedDeployment
    operation: specs/ocp-openapi.yaml#readAppsV1NamespacedDeployment
  - name: createCoreV1NamespacedService
    operation: specs/ocp-openapi.yaml#createCoreV1NamespacedService
  - name: createRouteOpenshiftIoV1NamespacedRoute
    operation: specs/ocp-openapi.yaml#createRouteOpenshiftIoV1NamespacedRoute
  - name: createNotification
    operation: notifications#createNotification
  - name: logInfo
    type: custom
    operation: "sysout:INFO"
  - name: increaseDeploymentStatusRunningRetries
    type: expression
    operation: ".deploymentStatusRunningRetries=.deploymentStatusRunningRetries + 1"
states:
  - name: LaunchSoftwareTemplate
    type: operation
    actions:
      - functionRef:
          refName: LaunchSoftwareTemplate
          arguments:
            templateRef: template:default/my-spring-petclinic-template
            values:
              port: 8080
              system: system:default/janus-orchestrator
              orgName: test-workflows
              repoName: petclinic-take2
              description: petclinic-take2 for automating the process
              owner: user:default/masayag
              groupId: org.springframework.samples
              artifactId: spring-petclinic
              javaPackageName: org/springframework/samples/petclinic
              ci: ./github-actions/
              imageRepository: quay.io
              imageNamespace: "********************"
              quayUserName: "*******"
              quayPassword: "********"
            secrets:
              imageNamespace: orchestrator-testing
              quayUserName: masayag
              quayPassword: Pf7#9Wds
        actionDataFilter:
          toStateData: .launchedTemplate
    stateDataFilter:
      output: ".launchedTemplate.id"
    transition: GetSoftwareTemplate
  - name: GetSoftwareTemplate
    type: operation
    actions:
      - functionRef:
          refName: logInfo
          arguments:
            message: "\"Sleeping before checking the software template \\(.launchedTemplate)\""
        sleep:
          after: PT10S
      - functionRef:
          refName: GetSoftwareTemplateTask
          arguments:
            taskId: .launchedTemplate.id
        actionDataFilter:
          toStateData: .readTask
    transition: IsTaskDone
  - name: IsTaskDone
    type: switch
    dataConditions:
      - condition: (.readTask.status == "processing")
        transition:
          nextState: GetSoftwareTemplate
      - condition: (.readTask.status == "completed")
        transition:
          nextState: SendTaskCompletedNotification
      - condition: (.readTask.status == "failed")
        transition:
          nextState: SendTaskFailureNotification
    defaultCondition:
      transition: GetSoftwareTemplate
  - name: SendTaskCompletedNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " completed software template creation." + .templateName '
              description: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " completed software template creation." + .templateName'
              topic: "AAP DB Deploy"
              link: ".launchedJob.outputUrl"
              severity: "normal"
    transition: LaunchAAPJob
  - name: SendTaskFailureNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " failed on software template creation." '
              description: '"AAP DB Deploy workflow ID: " + $WORKFLOW.instanceId + " for software template " + .templateName '
              topic: "AAP DB Deploy"
              severity: "high"
    end: true
  - name: LaunchAAPJob
    type: operation
    actions:
      - functionRef:
          refName: LaunchAAPJob
          arguments:
            job_template_id: 9
            limit: .limit
            extra_vars:
              rhel_inventory_group: .inventoryGroup
        actionDataFilter:
          toStateData: .launchedJob
    stateDataFilter:
      output: '.launchedJob += { outputUrl: $SECRET.app_url +  "/#/jobs/playbook/" + (.launchedJob.id|tostring) + "/output" }'
    transition: GetAAPJob
  - name: GetAAPJob
    type: operation
    actions:
      - functionRef:
          refName: logInfo
          arguments:
            message: "\"Sleeping before checking the aap job \\(.launchedJob)\""
        sleep:
          after: PT30S
      - functionRef:
          refName: GetAAPJob
          arguments:
            job_id: .launchedJob.id
        actionDataFilter:
          toStateData: .readJob
    transition: IsJobDone
  - name: IsJobDone
    type: switch
    dataConditions:
      - condition: (.readJob.status == "successful")
        transition:
          nextState: SendAAPJobCompletedNotification
      - condition: (.readJob.failed == true)
        transition:
          nextState: SendAAPJobFailureNotification
    defaultCondition:
      transition: SendAAPJobCompletedNotification
  - name: SendAAPJobCompletedNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " completed AAP Job to create DB." '
              description: '"AAP DB Deploy workflow ID: " + $WORKFLOW.instanceId + " for job template id: 9 completed."'
              topic: "AAP DB Deploy"
              link: ".launchedJob.outputUrl"
              severity: "normal"
    transition: Create Deployment

  - name: Create Deployment
    type: operation
    actions:
      - functionRef:
          refName: createAppsV1NamespacedDeployment
          arguments:
            namespace: default
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              annotations:
              labels:
                app: spring-petclinic
                app.kubernetes.io/component: web
                app.kubernetes.io/instance: spring-petclinic
                app.kubernetes.io/name: spring-petclinic
                app.kubernetes.io/part-of: spring-petclinic
                app.openshift.io/runtime: java
              name: spring-petclinic
            spec:
              replicas: 1
              selector:
                matchLabels:
                  app: spring-petclinic
              template:
                metadata:
                  labels:
                    app: spring-petclinic
                spec:
                  containers:
                    - name: spring-petclinic
                      imagePullPolicy: Always
                      image: quay.io/nmalvankar/spring-petclinic:latest
                      livenessProbe:
                        failureThreshold: 3
                        httpGet:
                          path: /
                          port: webcache
                          scheme: HTTP
                        initialDelaySeconds: 45
                        periodSeconds: 10
                        successThreshold: 1
                        timeoutSeconds: 1
                      env:
                        # TODO get those values from installed playbook
                        - name: POSTGRES_URL
                          value: .psqlURL
                        - name: POSTGRES_USER
                          value: "vincent"
                        - name: POSTGRES_PASS
                          value: "vincent"
                      ports:
                        - containerPort: 8080
                          protocol: TCP
                        - containerPort: 8443
                          protocol: TCP
                        - containerPort: 8778
                          protocol: TCP
                      readinessProbe:
                        failureThreshold: 3
                        httpGet:
                          path: /
                          port: webcache
                          scheme: HTTP
                        initialDelaySeconds: 45
                        periodSeconds: 10
                        successThreshold: 1
                        timeoutSeconds: 5
        actionDataFilter:
          toStateData: .createdDeployment
    transition: InitDeploymentStatusRunningRetry
  - name: InitDeploymentStatusRunningRetry
    type: inject
    data:
      deploymentStatusRunningRetries: 0
    transition: Poll Deployment
  - name: Poll Deployment
    type: operation
    actions:
      - name: get VM
        actionDataFilter:
          toStateData: .deployment
        functionRef:
          refName: readAppsV1NamespacedDeployment
          arguments:
            namespace: default
            name: spring-petclinic
        sleep:
          before: PT10S
    transition: increaseDeploymentStatusRunningRetriesRetry
  - name: increaseDeploymentStatusRunningRetriesRetry
    type: operation
    actions:
      - functionRef:
          refName: increaseDeploymentStatusRunningRetries
    transition: Check Deployment
  - name: Check Deployment
    type: switch
    dataConditions:
      - name: Deployment running
        condition: .deployment.status.readyReplicas >= 1
        transition: Create Service
      - name: Deployment not running
        condition: (.deploymentStatusRunningRetries > ($SECRET.deployment_check_running_max_retries | tonumber))
        transition: Notify Deployment no replicas available
    defaultCondition:
      transition:
        nextState: Poll Deployment
  - name: Create Service
    type: operation
    actions:
      - functionRef:
          refName: createCoreV1NamespacedService
          arguments:
            namespace: default
            apiVersion: v1
            kind: Service
            metadata:
              labels:
                app: spring-petclinic
              name: spring-petclinic
            spec:
              ports:
                - name: 8080-tcp
                  port: 8080
                  protocol: TCP
                  targetPort: 8080
                - name: 8443-tcp
                  port: 8443
                  protocol: TCP
                  targetPort: 8443
                - name: 8778-tcp
                  port: 8778
                  protocol: TCP
                  targetPort: 8778
              selector:
                app: spring-petclinic
              sessionAffinity: None
              type: ClusterIP
        actionDataFilter:
          toStateData: .createdService
    transition: Create Route
  - name: Create Route
    type: operation
    actions:
      - functionRef:
          refName: createRouteOpenshiftIoV1NamespacedRoute
          arguments:
            namespace: default
            apiVersion: route.openshift.io/v1
            kind: Route
            metadata:
              labels:
                app: spring-petclinic
              name: spring-petclinic
            spec:
              port:
                targetPort: 8080-tcp
              to:
                kind: Service
                name: spring-petclinic
                weight: 100
              tls:
                termination: edge
                insecureEdgeTerminationPolicy: Redirect
              wildcardPolicy: None
        actionDataFilter:
          toStateData: .createdRoute
    transition: SendSuccessNotification
  - name: SendAAPJobFailureNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " failed on AAP Job." '
              description: '"AAP DB Deploy workflow ID: " + $WORKFLOW.instanceId + " for job template id: 9 failed."'
              topic: "AAP DB Deploy"
              link: ".launchedJob.outputUrl"
              severity: "high"
    end: true
  - name: Notify Deployment no replicas available
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " failed on Deployment creation." '
              description: '"AAP DB Deploy workflow ID: " + $WORKFLOW.instanceId + " failed to create the Deployment: " + .deployment.metadata.name '
              topic: "AAP DB Deploy"
              severity: "high"
    end: true
  - name: SendSuccessNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: .recipients
            payload:
              title: '"AAP DB Deploy workflow " + $WORKFLOW.instanceId + " success." '
              description: '"AAP DB Deploy workflow ID: " + $WORKFLOW.instanceId + " for job template id: 9 succeeded. Deployment is in ready state."'
              topic: "AAP DB Deploy"
              link: '"https://" + .createdRoute.status.ingress[0].host'
              severity: "normal"
    end: true
